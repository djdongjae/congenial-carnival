<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=no">
    <title>몬테소리 콘텐츠</title>
    <style>
        svg {
            /*border: 1px solid #000;*/
            display: block;
            margin: 5px auto;
            cursor: crosshair;
            width: 630px;
            height: 630px;
        }
    </style>
</head>

<body>

    <svg id="paintSvg" data-name="paintSvg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="100 270 400 380">
        <!-- Generator: Adobe Illustrator 29.3.0, SVG Export Plug-In . SVG Version: 2.1.0 Build 146)  -->
        <defs>
            <style>
                .st0 {
                    fill: #efeeed;
                }

                .st1 {
                    fill: #3cb37a;
                }

                .st2 {
                    fill: #231815;
                }

                .st3 {
                    fill: #fff;
                    stroke: #3cb37a;
                    stroke-miterlimit: 10;
                    stroke-width: 2.5px;
                }
            </style>
        </defs>
        <!-- 마스킹 그룹 -->
        <defs>
            <clipPath id="clipPath1">
                <use id="clipRef1" href="#fillArea1" />
            </clipPath>
            <clipPath id="clipPath2">
                <use id="clipRef2" href="#fillArea2" />
            </clipPath>
        </defs>

        <g>
            <rect class="st1" x="113.13" y="273.29" width="359.01" height="291.31" />
            <rect class="st0" x="113.13" y="349.68" width="359.01" height="291.31" />
        </g>
        <g>
            <path class="st2" d="M243.73,299.21c4.87,0,7.74,4.62,7.74,11.22s-2.86,11.12-7.74,11.12-7.74-4.59-7.74-11.16,2.89-11.19,7.74-11.19ZM243.73,302.51c-2.23,0-3.9,2.97-3.9,7.89s1.67,7.86,3.9,7.86,3.99-2.94,3.99-7.86-1.7-7.89-3.99-7.89ZM259.08,309.08h4.43v3.4h-4.43v15.88h-3.96v-31.29h3.96v12.01Z" />
            <path class="st2" d="M264.71,324.26v-3.27h26.92v3.27h-26.92ZM267.13,302.74v-3.27h21.95v3.27h-21.95ZM267.19,315.48v-3.27h4.37l-.85-7.23,3.93-.5.6,7.72h5.94l1.07-7.66,3.8.63-1.26,7.03h4.21v3.27h-21.83Z" />
            <path class="st2" d="M312.2,320.17c-3.14.69-8.68,1.02-13.74,1.02h-3.15v-12.97h9.69v-5.21h-9.81v-3.27h13.74v11.72h-9.72v6.37c2.83,0,8.74-.17,12.55-.92l.44,3.27ZM318.27,297.07v31.29h-3.9v-31.29h3.9Z" />
            <path class="st2" d="M337.83,300.24c0,10.53-4.34,18.05-13.24,22.91-.82-.96-1.6-1.95-2.42-2.94,4.15-1.98,7.58-5.21,9.62-9.34-2.77.33-5.5.66-8.27.96l-.54-3.53,10.09-.79c.31-1.22.54-2.51.63-3.86h-9.28v-3.4h13.4ZM345.85,309.08h4.18v3.4h-4.18v15.88h-3.87v-31.29h3.87v12.01Z" />
        </g>
        <g>
            <path id="fillArea1" class="st3" onmousedown="onclickPath(1)" ontouchstart="onclickPath(1)" d="M384.37,582.23s-1.37-10.02,1.82-10.47,2.73-7.74,2.73-7.74c0,0-.91-9.11,4.55-9.56s7.74-4.1,7.74-6.83,9.56-9.11,11.84-3.19,6.37,8.19,0,8.65c-6.37.46-5.46,6.21-4.55,9.02s-.91,2.36-2.73,10.55c-1.82,8.19-2.34,13.66-5.5,15.93s-17.72,4.1-15.9-6.37Z" />
            <path id="fillArea2" class="st3" onmousedown="onclickPath(2)" ontouchstart="onclickPath(2)" d="M211.36,386.01s3.57-8.19,15.67-10.02,28.95,3.19,38.05,0,11.84-2.23,10.93,4.8,0,10.68,5.46,10.68,7.28-1.82,11.84,3.64,12.75,7.74,11.38,2.28,2.73-7.74,10.93-5.46,23.22,5.92,28.23,3.64,10.02-3.3,10.93,4.95c.91,8.25,12.75,24.18,15.93,30.1s0,13.66,7.28,17.76c7.28,4.1,8.19,13.02,13.66,13.8,5.46.77,15.93,1.05,21.85,0,5.92-1.05,4.1,5.78,0,9.42s-7.74,20.94-23.22,26.41-5.13,15.02-6.21,20.03,6.21,13.2-2.9,15.02c-9.11,1.82-8.19,6.83-6.83,10.93s1.82,11.84-6.37,15.93-15.48,3.19-15.02,13.66c.46,10.47,6.37,13.53-3.19,16.78s-3.19,4.16-9.11,13.27c-5.92,9.11-11.84,18.21-23.22,19.12-11.38.91-16.39,6.83-23.22,5.46s-6.37-1.82-6.83-9.56-6.37-8.65-10.02-18.21-1.82-10.47-1.37-17.3-15.93-21.85-9.56-31.87c6.37-10.02,5.01-5.01,8.19-15.48,3.19-10.47.91-10.93-5.01-19.12-5.92-8.19-13.2-12.75-6.83-17.76s2.73-17.3-4.55-15.48c-7.28,1.82-13.2-4.1-15.93-4.1s-3.19,1.37-10.47,2.73c-7.28,1.37-22.76,5.92-33.69.91-10.93-5.01-14.11-6.83-14.11-6.83,0,0-11.84-.46-13.2,0s-2.28-4.1,7.28-5.92c9.56-1.82-.91-5.92-3.19-5.92s-10.79-7.74-4.94-14.11,2.21-15.02,1.3-20.03,2.73-6.37,8.65-10.02,1.82-10.02,12.29-15.48c0,0,10.47-7.74,10.47-10.02s8.65-8.65,8.65-8.65Z" />
        </g>
        <!-- 사용자가 그리는 영역 (마스킹 적용) -->
        <g id="drawingGroup1" clip-path="url(#clipPath1)"></g>
        <g id="drawingGroup2" clip-path="url(#clipPath2)"></g>

    </svg>


    <script>
        const svg = document.getElementById("paintSvg");
        let clipRef = document.getElementById("clipRef1");
        let drawingGroup = document.getElementById("drawingGroup1"); // 초기 그리기 그룹은 첫 번째 영역
        let fillArea = document.getElementById("fillArea1");
        let drawing = false;
        let currentPath = null;
        let callFlutter = false;
		
		// 확대/축소 변수
        let scale = 1;
        let lastDistance = 0;
        let currentX = 0, currentY = 0; // 드래그 위치
        let isDragging = false;

        // 영역 클릭 시 해당 영역으로 전환
        function onclickPath(id) {
            fillArea = document.getElementById(`fillArea${id}`);

            if (!fillArea) return;

            drawingGroup = document.getElementById(`drawingGroup${id}`);
        }

        // SVG 좌표 변환 함수
        function getSVGCoords(event) {
            const point = svg.createSVGPoint();
            let x, y;

            if (event.touches) {
                x = event.touches[0].clientX;
                y = event.touches[0].clientY;
            } else {
                x = event.clientX;
                y = event.clientY;
            }

            point.x = x;
            point.y = y;
            return point.matrixTransform(svg.getScreenCTM().inverse());
        }

        // 경로 내부 점인지 확인하는 함수
        function isInsidePath(x, y) {
            const point = svg.createSVGPoint();
            point.x = x;
            point.y = y;
            return fillArea.isPointInFill(point);
        }

        // 그리기 시작 함수
        function startDrawing(e) {
            e.preventDefault();
            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            drawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            currentPath.setAttribute("stroke", "green");
            currentPath.setAttribute("stroke-width", "10");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("points", `${x},${y}`);
            drawingGroup.appendChild(currentPath);

            resetDrawTimer();
        }

        // 그리기 이동 함수
        function moveDrawing(e) {
            if (!drawing) return;
            e.preventDefault();

            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            let points = currentPath.getAttribute("points");
            points += ` ${x},${y}`;
            currentPath.setAttribute("points", points);
        }

        // 그리기 종료 함수
        function stopDrawing() {
            drawing = false;
        }

        // Flutter 호출 함수
        function resetDrawTimer() {
            if (!callFlutter) {
                console.log(callFlutter);
                callFlutter = true;
                window.drawCanvas.postMessage(JSON.stringify({
                    data: 'draw'
                }));
            }
        }
		
		// 줌 처리 함수
        function handleZoom(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                let distance = Math.sqrt(dx * dx + dy * dy);
    
                if (lastDistance !== 0) {
                    let delta = distance - lastDistance;
                    scale += delta * 0.005; // 줌 속도
                    scale = Math.max(1.0, Math.min(2.5, scale)); // 줌 한계 (0.5배 ~ 3배)
                    svg.setAttribute("style", `transform: scale(${scale})`);
                }
    
                lastDistance = distance; // 마지막 거리 업데이트
                e.preventDefault(); // 기본 동작(스크롤 등)을 막음
            }
        }
    
        // 첫 번째 터치 시 초기화
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                lastDistance = Math.sqrt(dx * dx + dy * dy); // 초기 거리 계산
            }
        }
    
        // 터치 끝날 때
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                lastDistance = 0; // 두 손가락이 하나로 떨어지면 초기화
            }
        }
    
        // 드래그 이동 함수
        function handleMouseDown(e) {
            isDragging = true;
            currentX = e.clientX;
            currentY = e.clientY;
            svg.style.cursor = 'grabbing';
        }
    
        function handleMouseMove(e) {
            if (!isDragging) return;
    
            const dx = e.clientX - currentX;
            const dy = e.clientY - currentY;
            currentX = e.clientX;
            currentY = e.clientY;
    
            const transform = svg.getAttribute('transform') || 'translate(0, 0)';
            const regex = /translate\((-?\d+), (-?\d+)\)/;
            const match = transform.match(regex);
    
            const newX = (match ? parseInt(match[1]) : 0) + dx;
            const newY = (match ? parseInt(match[2]) : 0) + dy;
            svg.setAttribute('transform', `translate(${newX}, ${newY})`);
        }
    
        function handleMouseUp() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }
    
        function handleMouseLeave() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        // 마우스 이벤트 리스너
        svg.addEventListener("mousedown", startDrawing);
        svg.addEventListener("mousemove", moveDrawing);
        svg.addEventListener("mouseup", stopDrawing);
        svg.addEventListener("mouseleave", stopDrawing);

        // 터치 이벤트 리스너
        svg.addEventListener("touchstart", function (e) {
            if (e.touches.length === 1) {
                startDrawing(e); // 한 손가락으로 그리기 시작
            } else if (e.touches.length === 2) {
                handleTouchStart(e); // 두 손가락 줌 시작
            }
        });
    
        svg.addEventListener("touchmove", function (e) {
            if (e.touches.length === 1) {
                moveDrawing(e); // 한 손가락으로 그리기 이동
            } else if (e.touches.length === 2) {
                handleZoom(e); // 두 손가락 줌 처리
            }
        });
    
        svg.addEventListener("touchend", function (e) {
            stopDrawing(); // 그리기 종료
            handleTouchEnd(e); // 두 손가락 처리 종료
        });
    </script>
</body>

</html>