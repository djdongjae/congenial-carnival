<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=no">
    <title>몬테소리 콘텐츠</title>
    <style>
        svg {
            /*border: 1px solid #000;*/
            display: block;
            margin: 5px auto;
            cursor: crosshair;
            width: 630px;
            height: 630px;
        }
    </style>
</head>

<body>


    <svg id="paintSvg" data-name="paintSvg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="100 190 400 380">
        <!-- Generator: Adobe Illustrator 29.3.0, SVG Export Plug-In . SVG Version: 2.1.0 Build 146)  -->
        <defs>
            <style>
                .st0 {
                    fill: #efeeed;
                }

                .st1 {
                    fill: #231815;
                }

                .st2 {
                    fill: #afd8b5;
                }

                .st3 {
                    fill: #fff;
                    stroke: #afd8b5;
                    stroke-miterlimit: 10;
                    stroke-width: 2.57px;
                }
            </style>
        </defs>
        <!-- 마스킹 그룹 -->
        <defs>
            <clipPath id="clipPath1">
                <use id="clipRef1" href="#fillArea1" />
            </clipPath>
            <clipPath id="clipPath2">
                <use id="clipRef2" href="#fillArea2" />
            </clipPath>
            <clipPath id="clipPath3">
                <use id="clipRef3" href="#fillArea3" />
            </clipPath>
            <clipPath id="clipPath4">
                <use id="clipRef4" href="#fillArea4" />
            </clipPath>
            <clipPath id="clipPath5">
                <use id="clipRef5" href="#fillArea5" />
            </clipPath>
            <clipPath id="clipPath6">
                <use id="clipRef6" href="#fillArea6" />
            </clipPath>
        </defs>
        <rect class="st2" x="118.86" y="190.98" width="359.01" height="291.31" />
        <rect class="st0" x="118.86" y="269.72" width="359.01" height="291.31" />
        <g>
            <path id="fillArea1" class="st3" onmousedown="onclickPath(1)" ontouchstart="onclickPath(1)" d="M148.27,480.94s8.64,7.77,22.45,0c13.82-7.77,10.36,1.73,26.77-7.77,16.41-9.5,19-6.04,38-6.91,19-.86,23.32,21.59,25.91,18.13,2.59-3.45,6.04-12.95,6.91-5.18.86,7.77,3.45,24.18,4.32,19,.86-5.18,6.91-9.24,14.68.99,7.77,10.23,12.95,9.37,25.04,6.78,12.09-2.59,22.46,4.32,26.34-9.5,3.88-13.82,2.16-13.82,9.93-25.91,7.77-12.09,17.27-22.45,9.5-31.95-7.77-9.5-18.13-21.59-19.43-25.04-1.3-3.45.43-14.68-8.21-17.27-8.64-2.59-13.82-12.09-14.68-19-.86-6.91-13.82-13.82-13.82-20.73s-8.64-22.45-8.64,0,0,30.22-6.91,27.63c-6.91-2.59-25.91-19-21.59-21.59,4.32-2.59,2.59-12.95-3.45-12.95s-22.45-13.9-28.5-4.79c-6.04,9.11,4.32,24.65-5.18,20.33-9.5-4.32-12.95-13.82-24.18-5.18-11.23,8.64-17.27,22.45-23.32,27.63-6.04,5.18-44.04,3.45-39.72,26.77,4.32,23.32-2.67,9.32-5.18,25.04-3.03,19,9.5,36.27,12.95,41.45Z" />
            <path id="fillArea2" class="st3" onmousedown="onclickPath(2)" ontouchstart="onclickPath(2)" d="M315.8,543.11s-6.04-12.09-6.04-19,25.04-8.64,22.45,0c-2.59,8.64-7.77,28.5-16.41,19Z" />
            <path id="fillArea3" class="st3" onmousedown="onclickPath(3)" ontouchstart="onclickPath(3)" d="M274.35,329.81s22.45,14.68,28.5,4.32c6.04-10.36,15.54-4.69,25.91,3.7,10.36,8.39,20.73,9.75,19,0-1.73-9.75-13.63-3.7-26.68-17.52-13.05-13.82-12.18-14.68-26-18.13-13.82-3.45-19-10.36-25.91-8.64-6.91,1.73-9.5,8.64-12.95,6.91-3.45-1.73-.17-14.68-8.29-14.68s-28.85-7.77-21.94,0c6.91,7.77,17.1,1.73,21.94,10.36,4.83,8.64-5.53,12.95,3.97,12.95s-6.04,16.41,22.45,20.73Z" />
            <path id="fillArea4" class="st3" onmousedown="onclickPath(4)" ontouchstart="onclickPath(4)" d="M411.41,546.32s-7.77,6.91-13.82-4.32c-6.05-11.23,0-28.5,6.91-28.5s18.13-10.24,16.41-18.94c-1.73-8.7,13.82-9.56,15.54-3.52,1.73,6.04.86,24.12,0,26.74-.86,2.62-22.21,11.26-20.17,13.85,2.04,2.59,3.65,13.27-4.87,14.68Z" />
            <path id="fillArea5" class="st3" onmousedown="onclickPath(5)" ontouchstart="onclickPath(5)" d="M455.45,480.89s-11.23,12.74-12.09,6.27c-.86-6.47-12.69-10.86-5.91-16.87,6.77-6.01,2.01-13.78-2.09-19.83-4.09-6.04,0-6.91,10.04,0,10.04,6.91,20.41,4.32,18.68,12.95-1.73,8.64-8.64,17.47-8.64,17.47Z" />
            <path id="fillArea6" class="st3" onmousedown="onclickPath(6)" ontouchstart="onclickPath(6)" d="M338.69,309.09s-21.65,5.18-6.29,10.36,21.4,2.74,23.13-5.97c1.73-8.71-2.21-19.07-7.58-18.21-5.37.86-3.48,12.01-9.25,13.82Z" />
        </g>
        <!-- 사용자가 그리는 영역 (마스킹 적용) -->
        <g id="drawingGroup1" clip-path="url(#clipPath1)"></g>
        <g id="drawingGroup2" clip-path="url(#clipPath2)"></g>
        <g id="drawingGroup3" clip-path="url(#clipPath3)"></g>
        <g id="drawingGroup4" clip-path="url(#clipPath4)"></g>
        <g id="drawingGroup5" clip-path="url(#clipPath5)"></g>
        <g id="drawingGroup6" clip-path="url(#clipPath6)"></g>
        <g>
            <path class="st1" d="M231.12,243.59v-3.06h11.5v-4.97c-5.48-.59-8.95-3.58-8.95-7.69,0-4.57,4.35-7.75,10.97-7.75s10.97,3.18,10.97,7.75c0,4.14-3.53,7.13-9.08,7.69v4.97h11.57v3.06h-26.98ZM244.64,223.24c-4.22,0-7,1.91-7,4.66s2.77,4.63,7,4.63,7-1.88,7-4.63-2.74-4.66-7-4.66Z" />
            <path class="st1" d="M272.21,240.1c-1.95-1.17-4.63-4.11-5.42-6.98-.82,3.06-3.09,6.08-5.86,7.72l-2.3-2.62c3.78-2.41,6.24-6.82,6.24-13.06v-4.35h3.78v4.32c0,5.68,2.18,10.13,5.8,12.26l-2.24,2.72ZM275.14,245.87v-14.69h-4.03v-3.12h4.03v-9.54h3.66v27.35h-3.66ZM281.03,247.23v-29.26h3.72v29.26h-3.72Z" />
            <path class="st1" d="M295.56,219.97c4.89,0,7.75,4.32,7.75,10.5s-2.87,10.4-7.75,10.4-7.75-4.29-7.75-10.43,2.9-10.46,7.75-10.46ZM295.56,223.06c-2.24,0-3.91,2.78-3.91,7.38s1.67,7.35,3.91,7.35,4-2.75,4-7.35-1.7-7.38-4-7.38ZM310.94,229.2h4.44v3.18h-4.44v14.85h-3.97v-29.26h3.97v11.24Z" />
            <path class="st1" d="M334.07,238.59c-3.63.93-10.34,1.33-13.87,1.33h-2.74v-19.02h3.88v15.74c4.07,0,8.95-.37,12.23-1.14l.5,3.09ZM340.47,247.23h-3.88v-29.26h3.88v29.26Z" />
            <path class="st1" d="M352.03,219.97c4.89,0,7.75,4.32,7.75,10.5s-2.87,10.4-7.75,10.4-7.75-4.29-7.75-10.43,2.9-10.46,7.75-10.46ZM352.03,223.06c-2.24,0-3.91,2.78-3.91,7.38s1.67,7.35,3.91,7.35,4-2.75,4-7.35-1.7-7.38-4-7.38ZM367.41,229.2h4.44v3.18h-4.44v14.85h-3.97v-29.26h3.97v11.24Z" />
        </g>
    </svg>


    <script>
        const svg = document.getElementById("paintSvg");
        let clipRef = document.getElementById("clipRef1");
        let drawingGroup = document.getElementById("drawingGroup1"); // 초기 그리기 그룹은 첫 번째 영역
        let fillArea = document.getElementById("fillArea1");
        let drawing = false;
        let currentPath = null;
        let callFlutter = false;
		
		// 확대/축소 변수
        let scale = 1;
        let lastDistance = 0;
        let currentX = 0, currentY = 0; // 드래그 위치
        let isDragging = false;

        // 영역 클릭 시 해당 영역으로 전환
        function onclickPath(id) {
            fillArea = document.getElementById(`fillArea${id}`);

            if (!fillArea) return;

            drawingGroup = document.getElementById(`drawingGroup${id}`);
        }

        // SVG 좌표 변환 함수
        function getSVGCoords(event) {
            const point = svg.createSVGPoint();
            let x, y;

            if (event.touches) {
                x = event.touches[0].clientX;
                y = event.touches[0].clientY;
            } else {
                x = event.clientX;
                y = event.clientY;
            }

            point.x = x;
            point.y = y;
            return point.matrixTransform(svg.getScreenCTM().inverse());
        }

        // 경로 내부 점인지 확인하는 함수
        function isInsidePath(x, y) {
            const point = svg.createSVGPoint();
            point.x = x;
            point.y = y;
            return fillArea.isPointInFill(point);
        }

        // 그리기 시작 함수
        function startDrawing(e) {
            e.preventDefault();
            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            drawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            currentPath.setAttribute("stroke", "green");
            currentPath.setAttribute("stroke-width", "10");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("points", `${x},${y}`);
            drawingGroup.appendChild(currentPath);

            resetDrawTimer();
        }

        // 그리기 이동 함수
        function moveDrawing(e) {
            if (!drawing) return;
            e.preventDefault();

            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            let points = currentPath.getAttribute("points");
            points += ` ${x},${y}`;
            currentPath.setAttribute("points", points);
        }

        // 그리기 종료 함수
        function stopDrawing() {
            drawing = false;
        }

        // Flutter 호출 함수
        function resetDrawTimer() {
    	    if(!callFlutter) {
               console.log(callFlutter);
				callFlutter = true;
    	       window.drawCanvas.postMessage(JSON.stringify({ data: 'draw' }));
			}
        }
		
		// 줌 처리 함수
        function handleZoom(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                let distance = Math.sqrt(dx * dx + dy * dy);
    
                if (lastDistance !== 0) {
                    let delta = distance - lastDistance;
                    scale += delta * 0.005; // 줌 속도
                    scale = Math.max(1.0, Math.min(2.5, scale)); // 줌 한계 (0.5배 ~ 3배)
                    svg.setAttribute("style", `transform: scale(${scale})`);
                }
    
                lastDistance = distance; // 마지막 거리 업데이트
                e.preventDefault(); // 기본 동작(스크롤 등)을 막음
            }
        }
    
        // 첫 번째 터치 시 초기화
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                lastDistance = Math.sqrt(dx * dx + dy * dy); // 초기 거리 계산
            }
        }
    
        // 터치 끝날 때
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                lastDistance = 0; // 두 손가락이 하나로 떨어지면 초기화
            }
        }
    
        // 드래그 이동 함수
        function handleMouseDown(e) {
            isDragging = true;
            currentX = e.clientX;
            currentY = e.clientY;
            svg.style.cursor = 'grabbing';
        }
    
        function handleMouseMove(e) {
            if (!isDragging) return;
    
            const dx = e.clientX - currentX;
            const dy = e.clientY - currentY;
            currentX = e.clientX;
            currentY = e.clientY;
    
            const transform = svg.getAttribute('transform') || 'translate(0, 0)';
            const regex = /translate\((-?\d+), (-?\d+)\)/;
            const match = transform.match(regex);
    
            const newX = (match ? parseInt(match[1]) : 0) + dx;
            const newY = (match ? parseInt(match[2]) : 0) + dy;
            svg.setAttribute('transform', `translate(${newX}, ${newY})`);
        }
    
        function handleMouseUp() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }
    
        function handleMouseLeave() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        // 마우스 이벤트 리스너
        svg.addEventListener("mousedown", startDrawing);
        svg.addEventListener("mousemove", moveDrawing);
        svg.addEventListener("mouseup", stopDrawing);
        svg.addEventListener("mouseleave", stopDrawing);

        // 터치 이벤트 리스너
        svg.addEventListener("touchstart", function (e) {
            if (e.touches.length === 1) {
                startDrawing(e); // 한 손가락으로 그리기 시작
            } else if (e.touches.length === 2) {
                handleTouchStart(e); // 두 손가락 줌 시작
            }
        });
    
        svg.addEventListener("touchmove", function (e) {
            if (e.touches.length === 1) {
                moveDrawing(e); // 한 손가락으로 그리기 이동
            } else if (e.touches.length === 2) {
                handleZoom(e); // 두 손가락 줌 처리
            }
        });
    
        svg.addEventListener("touchend", function (e) {
            stopDrawing(); // 그리기 종료
            handleTouchEnd(e); // 두 손가락 처리 종료
        });
    </script>
</body>

</html>