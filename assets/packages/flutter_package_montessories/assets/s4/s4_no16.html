<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=no">
    <title>몬테소리 콘텐츠</title>
    <style>
        svg {
            /*border: 1px solid #000;*/
            display: block;
            margin: 5px auto;
            cursor: crosshair;
            width: 630px;
            height: 630px;
        }
    </style>
</head>

<body>


    <?xml version="1.0" encoding="UTF-8"?>
    <svg id="paintSvg" data-name="paintSvg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="100 270 400 380">
        <!-- Generator: Adobe Illustrator 29.3.0, SVG Export Plug-In . SVG Version: 2.1.0 Build 146)  -->
        <defs>
            <style>
                .st0 {
                    fill: #e94830;
                }

                .st1 {
                    fill: #efeeed;
                }

                .st2 {
                    fill: #231815;
                }

                .st3 {
                    fill: #fff;
                    stroke: #e94830;
                    stroke-miterlimit: 10;
                    stroke-width: 1.8px;
                }
            </style>
        </defs>
        <!-- 마스킹 그룹 -->
        <defs>
            <clipPath id="clipPath1">
                <use id="clipRef1" href="#fillArea1" />
            </clipPath>
            <clipPath id="clipPath2">
                <use id="clipRef2" href="#fillArea2" />
            </clipPath>
            <clipPath id="clipPath3">
                <use id="clipRef3" href="#fillArea3" />
            </clipPath>
            <clipPath id="clipPath4">
                <use id="clipRef4" href="#fillArea4" />
            </clipPath>
            <clipPath id="clipPath5">
                <use id="clipRef5" href="#fillArea5" />
            </clipPath>
            <clipPath id="clipPath6">
                <use id="clipRef6" href="#fillArea6" />
            </clipPath>
            <clipPath id="clipPath7">
                <use id="clipRef7" href="#fillArea7" />
            </clipPath>
        </defs>
        <g>
            <rect class="st0" x="112.83" y="270.94" width="359" height="83.56" transform="translate(-1.79 1.69) rotate(-.33)" />
            <rect class="st1" x="113.07" y="349.68" width="359.01" height="291.31" />
        </g>
        <g>
            <path class="st2" d="M270.96,328.32v-10.43h-6.32v-3.27h26.92v3.27h-6.45v10.43h-3.9v-10.43h-6.35v10.43h-3.9ZM278.07,312.38c-6.45,0-10.6-2.81-10.6-6.96s4.15-6.9,10.6-6.9,10.6,2.81,10.6,6.9-4.15,6.96-10.6,6.96ZM278.07,301.82c-4.06,0-6.54,1.55-6.54,3.6s2.48,3.66,6.54,3.66,6.51-1.58,6.51-3.66-2.52-3.6-6.51-3.6Z" />
            <path class="st2" d="M310.27,313.01c-2.55.66-7.67,1.09-11.64,1.09h-3.99v-9.6h9.31v-2.67h-9.31v-3.23h13.24v8.98h-9.31v3.3c3.62.13,8.96-.26,11.26-.96l.44,3.1ZM298.57,327.96v-12.01h3.93v3h11.83v-3.07h3.87v12.08h-19.62ZM314.33,322.12h-11.83v2.57h11.83v-2.57ZM314.29,314.43v-7.1h-4.59v-3.37h4.59v-6.9h3.9v17.36h-3.9Z" />
        </g>
        <g>
            <path id="fillArea1" class="st3" onmousedown="onclickPath(1)" ontouchstart="onclickPath(1)" d="M129.33,494.37s13.18-2.68,8.24,5.36c-4.94,8.04,5.49,3.75,8.24,4.82s9.89,3.09,12.08.2,6.04-5.56,9.89-8.24-2.75-11.25-5.49-9.11c-2.75,2.14-4.87,7.5-13.15,6.43-8.28-1.07-5.53-1.07-12.12-3.21-6.59-2.14-7.69,3.75-7.69,3.75Z" />
            <path id="fillArea2" class="st3" onmousedown="onclickPath(2)" ontouchstart="onclickPath(2)" d="M247.63,430.01s-8.47-3.94-7.13-7.89,2.7-4.51,7.13-1.31,4.43-.75,9.25-2.07,4.24,1.5,8.67,0,3.85-3.57,8.28-2.07,11.75-.56,13.87,2.25,8.46-1.31,6.64,2.25-10.3,1.31-14.53,3.38.58,6.2,5.2,7.89c4.62,1.69,5.2,6.01,0,5.63s-8.67,3.05-10.98.02-.39-4.34-.19-5.85-5.51-4.13-6.32-.56-4.66,5.26-2.93,8.83-2.89-.94-4.24,0,2.7,5.45-2.12,5.45-.58-5.82-1.16-6.39-5.97-3.57-3.27-5.63c2.7-2.07-1.93-3.76-6.16-3.94Z" />
            <path id="fillArea3" class="st3" onmousedown="onclickPath(3)" ontouchstart="onclickPath(3)" d="M395.75,479.97s-1.73,1.5-4.82-2.44c-3.08-3.94-3.47-6.76-8.86-7.7s-5.39-3.57-1.93-3.94.77-8.26,5.59-9.39,4.24-.38,6.36-5.45,3.27-6.76,9.82-6.39c6.55.38,8.67.28,12.33-.05s3.47-.51,10.02-2.02,7.32-3.76,7.13,0-4.82,8.83-6.74,12.21-3.85-.19-10.98.75c-7.13.94-15.02.56-17.14,2.82s-6.55,0-6.55,3.19,4.04,4.7,6.16,8.83,3.66,7.14,3.08,7.89,3.27,3.01-3.47,1.69Z" />
            <path id="fillArea4" class="st3" onmousedown="onclickPath(4)" ontouchstart="onclickPath(4)" d="M245.13,597.18s3.27-2.63,1.16-3.76-3.58-3.76.71-3.76,2.56,6.39,3.91,10.52.19,6.76-2.5,5.63-5.27-3.01-4.17-4.51.9-4.13.9-4.13Z" />
            <path id="fillArea5" class="st3" onmousedown="onclickPath(5)" ontouchstart="onclickPath(5)" d="M261.89,610.51s-1.93-.75,0-2.63,5.01-1.13,6.16-2.82-.77-8.08-4.82-8.83-6.36,0-7.7-3.19-2.5-6.39-6.55-7.14-9.05,1.69-12.33,2.07-6.93-3.01-7.13.38-4.24,9.84-7.9,9.52c-3.66-.32-6.74,3.81-2.5,5.32s2.12,4.7-.58,4.7-3.66-.19-5.39,1.13-4.82,1.5-6.74,1.5-4.43,3.76-6.93,3.01-.96-4.7-5.01-3.94-7.13,1.13-7.32-2.63,1.93-3.61.96-7.25-3.66-2.33,0-5.71-1.41-4.88-1.86-4.88-1.41-4.7,7.45-4.32c8.86.38,12.52,1.5,16.56,2.07s3.66-2.44,2.7-4.13,5.2-3.19,2.12-5.45-6.93-5.26-10.02-5.63c-3.08-.38-7.13-6.2-1.73-5.63s4.43,1.8,5.39-.04-.39-4.28,4.82-2.22c5.2,2.07,7.32-2.07,7.32-2.82s1.35-3.57-3.27-2.63-8.28,1.69-13.68,2.82-9.25,2.44-6.74-.19,5.01-4.13,4.24-4.88-6.55-2.25-3.66-3.94.77-5.26,3.08-5.63,0-5.45-2.31-3.01-4.43,12.02-6.16,10.89-4.27,4.32-6.37,3.76-1.72-4.51-3.07-3.38-7.32,1.69-4.43-1.5c2.89-3.19,7.32-3.94,5.39-5.26s-1.16-5.08,1.54-5.17,1.93-5.35,6.55-3.28c4.62,2.07,6.16,1.67,5.78-.48s-5.01-6.47-3.08-8.54,8.28-5.07,10.21-2.07,4.43,4.88,1.16,6.39,5.2,3.01,4.82,6.01.96,4.13,4.43,4.32c3.47.19-1.16,2.82.58,5.07s6.1-1.69,7.19,0,4.75,2.63,6.68.38,4.43-4.7,7.9-3.01c3.47,1.69,5.59,0,3.85-3.38s-1.74-11.65,2.5-10.14c4.24,1.5-.96,8.45,1.54,11.08s5.01,2.44,7.13.56,7.7-.56,11.75.56,10.4-.19,9.44-3.01-.96-3.94,3.85-3.01,7.13,1.69,7.51-2.25.39-6.39,6.36-5.07c5.97,1.31,3.66-2.07,1.73-4.13s1.16-8.64,5.01-5.63,8.47,5.07,9.82.38c1.35-4.7-9.44-4.7-15.41-3.19s-10.59-.38-10.21-3.19-3.27-9.64,3.66-10.92,7.13-8.61,4.24-7.3-10.02,7.7-15.79,9.02c-5.78,1.31-2.89,3.57-4.82,6.39s-2.12,5.63,1.93,6.01-2.7,3.94-1.93,6.39,1.16,9.39-3.27,11.27-20.99,7.14-16.76,2.07,3.66-12.96.39-14.46-6.36,4.13-12.52,3.38-8.86-2.25-6.93-6.2-4.24-9.39,4.24-12.4c8.47-3.01,13.48-6.57,14.64-10.33s3.85-12.21,9.05-14.09,4.24-11.65,13.1-10.89c8.86.75,7.13-3.01,12.9-3.01s8.86-2.07,11.56,0c2.7,2.07,10.21-3.19,13.87.75,3.66,3.94,10.4,5.07,15.99,6.01s18.11,5.45,19.45,8.08,3.47,7.14-5.2,6.76c-8.67-.38-16.95-5.82-20.8-2.07s9.44,2.82,7.32,6.57c-2.12,3.76,1.54,5.82,4.24,6.76s5.01,8.83,6.74,4.51-3.08-9.96-1.35-9.77,4.24,4.51,6.74,4.13,1.16-6.76,6.16-8.64c5.01-1.88,8.67-.56,5.59-4.32s-6.16-7.33-.39-7.51c5.78-.19,6.16.94,6.55,5.82s6.36,3.01,7.32,2.63,9.44-3.38,10.98-5.45,5.59-4.88,9.25-2.25,8.86,0,13.1,0,5.39,1.92,7.9.87,1.16-5-1.93-5.37-2.31-5.82.96-3.19,11.36-.13,14.25,3.97c2.89,4.1,14.06,9.74,5.59,12.37-8.47,2.63-13.1,7.89-15.99,12.58s3.27,10.52-3.47,13.71c-6.74,3.19-13.48-.56-17.33,1.13-3.85,1.69-9.05,0-10.4,1.69s-5.59,8.45-8.28,4.51-5.2-6.01-4.62-1.13-.77,9.96,5.2,8.64-2.5,2.44,2.31,2.82,5.39,3.19,10.02,3.57,7.7-2.82,9.63,0,2.31,9.39-.77,10.52-7.7-5.45-13.48-3.76-15.02,0-11.75,2.63c3.27,2.63,9.44,6.01,13.1,4.88s5.59,3.01,3.47,5.26c-2.12,2.25-1.73,8.64-6.74,9.2-5.01.56-3.85,3.76-.58,4.32s3.85,5.45,1.73,7.89.58,7.89,2.12,10.71,6.74,7.89,5.39,10.33c-1.35,2.44-5.78,3.57-12.13,1.5s-24.85-13.9-27.74-15.78c-2.89-1.88-7.32-5.45-10.4-3.57-3.08,1.88-8.28,1.69-9.44-1.13s-4.62-5.63-8.67-2.82c-4.04,2.82-9.44,8.26-5.01,11.27,4.43,3.01.19,6.57-3.08,7.14s-7.51-3.31-10.21-1c-2.7,2.31.75,6.44-7.04,1.75-7.79-4.7-7.6-6.2-13.57-7.89s-3.08-5.07-8.67-6.2-5.01.56-7.7-2.63-10.98-3.01-8.67.19,10.79,4.7,11.94,7.51,16.76,8.26,13.87,10.89-4.82,3.01-5.2,6.95-6.36,6.2-14.45,2.07Z" />
            <path id="fillArea6" class="st3" onmousedown="onclickPath(6)" ontouchstart="onclickPath(6)" d="M281.72,596.99s-1.54-4.13,2.12,0c3.66,4.13,6.55,4.7,9.63,6.2s4.43-.56,8.67,1.88,2.7,5.82-2.89,7.51-9.82.56-8.47-2.63-2.7-4.06-4.62-5.69-2.5-2.76-2.5-3.32-1.93-3.94-1.93-3.94Z" />
            <path id="fillArea7" class="st3" onmousedown="onclickPath(7)" ontouchstart="onclickPath(7)" d="M370.13,483.35s-5.01-.51-2.12-2.98,11.56-1.88,8.47,1.49-6.36,1.49-6.36,1.49Z" />
        </g>
        <!-- 사용자가 그리는 영역 (마스킹 적용) -->
        <g id="drawingGroup1" clip-path="url(#clipPath1)"></g>
        <g id="drawingGroup2" clip-path="url(#clipPath2)"></g>
        <g id="drawingGroup3" clip-path="url(#clipPath3)"></g>
        <g id="drawingGroup4" clip-path="url(#clipPath4)"></g>
        <g id="drawingGroup5" clip-path="url(#clipPath5)"></g>
        <g id="drawingGroup6" clip-path="url(#clipPath6)"></g>
        <g id="drawingGroup7" clip-path="url(#clipPath7)"></g>
    </svg>


    <script>
        const svg = document.getElementById("paintSvg");
        let clipRef = document.getElementById("clipRef1");
        let drawingGroup = document.getElementById("drawingGroup1"); // 초기 그리기 그룹은 첫 번째 영역
        let fillArea = document.getElementById("fillArea1");
        let drawing = false;
        let currentPath = null;
        let callFlutter = false;
		
		// 확대/축소 변수
        let scale = 1;
        let lastDistance = 0;
        let currentX = 0, currentY = 0; // 드래그 위치
        let isDragging = false;

        // 영역 클릭 시 해당 영역으로 전환
        function onclickPath(id) {
            fillArea = document.getElementById(`fillArea${id}`);

            if (!fillArea) return;

            drawingGroup = document.getElementById(`drawingGroup${id}`);
        }

        // SVG 좌표 변환 함수
        function getSVGCoords(event) {
            const point = svg.createSVGPoint();
            let x, y;

            if (event.touches) {
                x = event.touches[0].clientX;
                y = event.touches[0].clientY;
            } else {
                x = event.clientX;
                y = event.clientY;
            }

            point.x = x;
            point.y = y;
            return point.matrixTransform(svg.getScreenCTM().inverse());
        }

        // 경로 내부 점인지 확인하는 함수
        function isInsidePath(x, y) {
            const point = svg.createSVGPoint();
            point.x = x;
            point.y = y;
            return fillArea.isPointInFill(point);
        }

        // 그리기 시작 함수
        function startDrawing(e) {
            e.preventDefault();
            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            drawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            currentPath.setAttribute("stroke", "red");
            currentPath.setAttribute("stroke-width", "10");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("points", `${x},${y}`);
            drawingGroup.appendChild(currentPath);

            resetDrawTimer();
        }

        // 그리기 이동 함수
        function moveDrawing(e) {
            if (!drawing) return;
            e.preventDefault();

            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            let points = currentPath.getAttribute("points");
            points += ` ${x},${y}`;
            currentPath.setAttribute("points", points);
        }

        // 그리기 종료 함수
        function stopDrawing() {
            drawing = false;
        }

        // Flutter 호출 함수
        function resetDrawTimer() {
            if (!callFlutter) {
                console.log(callFlutter);
                callFlutter = true;
                window.drawCanvas.postMessage(JSON.stringify({
                    data: 'draw'
                }));
            }
        }
		
		// 줌 처리 함수
        function handleZoom(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                let distance = Math.sqrt(dx * dx + dy * dy);
    
                if (lastDistance !== 0) {
                    let delta = distance - lastDistance;
                    scale += delta * 0.005; // 줌 속도
                    scale = Math.max(1.0, Math.min(2.5, scale)); // 줌 한계 (0.5배 ~ 3배)
                    svg.setAttribute("style", `transform: scale(${scale})`);
                }
    
                lastDistance = distance; // 마지막 거리 업데이트
                e.preventDefault(); // 기본 동작(스크롤 등)을 막음
            }
        }
    
        // 첫 번째 터치 시 초기화
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                lastDistance = Math.sqrt(dx * dx + dy * dy); // 초기 거리 계산
            }
        }
    
        // 터치 끝날 때
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                lastDistance = 0; // 두 손가락이 하나로 떨어지면 초기화
            }
        }
    
        // 드래그 이동 함수
        function handleMouseDown(e) {
            isDragging = true;
            currentX = e.clientX;
            currentY = e.clientY;
            svg.style.cursor = 'grabbing';
        }
    
        function handleMouseMove(e) {
            if (!isDragging) return;
    
            const dx = e.clientX - currentX;
            const dy = e.clientY - currentY;
            currentX = e.clientX;
            currentY = e.clientY;
    
            const transform = svg.getAttribute('transform') || 'translate(0, 0)';
            const regex = /translate\((-?\d+), (-?\d+)\)/;
            const match = transform.match(regex);
    
            const newX = (match ? parseInt(match[1]) : 0) + dx;
            const newY = (match ? parseInt(match[2]) : 0) + dy;
            svg.setAttribute('transform', `translate(${newX}, ${newY})`);
        }
    
        function handleMouseUp() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }
    
        function handleMouseLeave() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        // 마우스 이벤트 리스너
        svg.addEventListener("mousedown", startDrawing);
        svg.addEventListener("mousemove", moveDrawing);
        svg.addEventListener("mouseup", stopDrawing);
        svg.addEventListener("mouseleave", stopDrawing);

        // 터치 이벤트 리스너
        svg.addEventListener("touchstart", function (e) {
            if (e.touches.length === 1) {
                startDrawing(e); // 한 손가락으로 그리기 시작
            } else if (e.touches.length === 2) {
                handleTouchStart(e); // 두 손가락 줌 시작
            }
        });
    
        svg.addEventListener("touchmove", function (e) {
            if (e.touches.length === 1) {
                moveDrawing(e); // 한 손가락으로 그리기 이동
            } else if (e.touches.length === 2) {
                handleZoom(e); // 두 손가락 줌 처리
            }
        });
    
        svg.addEventListener("touchend", function (e) {
            stopDrawing(); // 그리기 종료
            handleTouchEnd(e); // 두 손가락 처리 종료
        });
    </script>
</body>

</html>