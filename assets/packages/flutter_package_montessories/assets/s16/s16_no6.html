<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=no">
    <title>몬테소리 콘텐츠</title>
    <style>
        svg {
            /*border: 1px solid #000;*/
            display: block;
            margin: 0px auto;
            cursor: crosshair;
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>



    <?xml version="1.0" encoding="UTF-8"?>
    <svg id="paintSvg" data-name="paintSvg" xmlns="http://www.w3.org/2000/svg" version="1.1"
        xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="203 219 397 397">
        <!-- Generator: Adobe Illustrator 29.3.0, SVG Export Plug-In . SVG Version: 2.1.0 Build 146)  -->
        <defs>
            <style>
                .st0 {
                    fill: #d6dcdb;
                }

                .st1,
                .st2 {
                    fill: #fff;
                }

                .st3 {
                    fill: #d3d3d4;
                }

                .st2,
                .st4,
                .st5 {
                    stroke-miterlimit: 10;
                }

                .st2,
                .st5 {
                    stroke: #d3d3d4;
                }

                .st6 {
                    fill: #231815;
                }

                .st7 {
                    fill: #2f72b9;
                }

                .st4 {
                    stroke: #231815;
                    stroke-width: .61px;
                }

                .st4,
                .st5 {
                    fill: none;
                }

                .st8 {
                    fill: #aaabab;
                }

                .st5 {
                    stroke-width: 1.16px;
                }

                .st9 {
                    fill: url(#_무제_그라디언트_9);
                }
            </style>
            <linearGradient id="_무제_그라디언트_9" data-name="무제 그라디언트 9" x1="214.26" y1="340.66" x2="203.01" y2="340.66"
                gradientUnits="userSpaceOnUse">
                <stop offset="0" stop-color="#fff" />
                <stop offset="1" stop-color="#acacad" />
            </linearGradient>
        </defs>
        <!-- 마스킹 그룹 -->
        <defs>
            <clipPath id="clipPath1">
                <use id="clipRef1" href="#fillArea1" />
            </clipPath>
        </defs>
        <rect class="st5" x="105.31" y="241.15" width="204.27" height="275" />
        <rect class="st3" x="105.31" y="445" width="204.27" height="71.15" />
        <g>
            <path class="st7"
                d="M175.76,307.92s1.52-37.92,34.91-37.92,34.16,37.92,34.16,37.92c0,0,36.15-.19,34.16,34.95-1.9,33.42-35.81,33.32-35.81,33.32,0,0,2.52,42.84-37.06,40.15-33.54-2.28-30.36-37.44-30.36-37.44,0,0-36.37-.97-36.43-35.59-.05-30.86,28.84-38.46,36.43-35.39Z" />
            <g>
                <path class="st9"
                    d="M214.26,332.87h-11.25l.87,11.33c0,.09.37,4.26,4.78,4.26,2.66,0,4.18-1.68,4.47-3.57l1.14-12.01Z" />
                <path class="st8" d="M203.21,333.76s4.37,5.72,10.4,1.48c0,0-4.11,3.87-10.15,3.48l-.25-4.96Z" />
                <ellipse class="st1" cx="208.64" cy="332.65" rx="5.63" ry="4.16" />
            </g>
        </g>
        <g>
            <path class="st2" id="fillArea1" onmousedown="onclickPath(1)" ontouchstart="onclickPath(1)"
                d="M338.21,240.7v276.61h171.57V240.7h-171.57ZM344.95,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM354.85,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM364.76,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM374.67,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM384.58,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM394.49,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM404.4,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM414.31,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM424.22,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM434.13,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM444.03,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM453.94,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM463.85,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM473.76,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM483.67,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM493.58,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23ZM503.49,247.92c-1.23,0-2.23-1-2.23-2.23s1-2.23,2.23-2.23,2.23,1,2.23,2.23-1,2.23-2.23,2.23Z" />
            <path class="st0"
                d="M463.85,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M384.58,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.5,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M374.67,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M364.76,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M354.85,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M344.95,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M394.49,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M404.4,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.5,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M414.31,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.5,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M424.22,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M434.13,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M444.03,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.5,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M453.94,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.5,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M473.76,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M483.67,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.51-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M493.58,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.5,1.13-1.13,1.13h0Z" />
            <path class="st0"
                d="M503.49,246.43c-.62,0-1.13-.51-1.13-1.13v-6.81c0-.62.5-1.13,1.13-1.13h0c.62,0,1.13.51,1.13,1.13v6.81c0,.62-.51,1.13-1.13,1.13h0Z" />
        </g>
        <g>
            <path class="st6"
                d="M132.46,481.24v-4.2h16.13v-6.38h5.25v6.38h14.58v4.2h-35.96ZM163.25,501.87c-5.84-.25-11.38-3.36-12.98-5.5-1.51,2.31-7.06,5.33-12.94,5.42l-2.23-4.08c5.67.04,10.96-2.1,12.27-4.96h-10.75v-4.03h27.68v4.03h-11.01c1.22,2.9,6.43,5,12.27,5.17l-2.31,3.95ZM148,462.13c0,5.25-.97,9.83-2.18,12.98l-5.04-1.09c.88-1.68,1.85-4.75,1.93-7.77h-7.35v-4.12h12.64ZM144.1,487.04v-3.95h12.77v3.95h-12.77ZM164.81,462.13c0,5.08-.25,9.45-1.47,12.98l-5.04-.84c.92-2.23,1.3-5.5,1.3-8.02h-8.57v-4.12h13.78Z" />
            <path class="st6"
                d="M190.97,490.95h-18.9v-25.83h18.9v25.83ZM185.76,469.31h-8.49v17.47h8.49v-17.47ZM202.23,476.71h5.42v4.33h-5.42v20.21h-5.29v-39.82h5.29v15.29Z" />
            <path class="st6"
                d="M209.74,485.95v-4.16h35.96v4.16h-35.96ZM214.28,500.73v-12.22h26.88v12.22h-26.88ZM214.49,479.35v-10.12h21.17v-2.39h-21.21v-3.91h26.46v10.04h-21.21v2.44h22.14v3.95h-27.35ZM235.87,492.5h-16.38v4.24h16.38v-4.24Z" />
            <path class="st6"
                d="M248.76,472.8v-4.08h20.92v4.08h-20.92ZM259.55,487.12c-5.46,0-9.49-2.65-9.49-6.59s3.99-6.64,9.49-6.64,9.45,2.69,9.45,6.64-3.99,6.59-9.45,6.59ZM254.01,462.93h11.17v4.08h-11.17v-4.08ZM267.83,501.45c-8.57,0-13.74-2.52-13.74-6.97s5.17-6.89,13.74-6.89,13.82,2.56,13.82,6.89-5.17,6.97-13.82,6.97ZM259.55,483.3c2.35,0,4.33-1.18,4.33-2.77s-1.97-2.81-4.33-2.81-4.33,1.18-4.33,2.81,1.97,2.77,4.33,2.77ZM259.51,494.52c0,1.72,3.07,2.94,8.32,2.94s8.36-1.22,8.36-2.94-2.98-2.9-8.36-2.9-8.32,1.22-8.32,2.9ZM276.06,487.5v-4.96h-5.21v-3.99h5.21v-3.53h-5.17v-3.99h5.17v-9.62h5.25v26.09h-5.25Z" />
        </g>
        <!-- 사용자가 그리는 영역 (마스킹 적용) -->
        <g id="drawingGroup1" clip-path="url(#clipPath1)"></g>
    </svg>

    <script>
        const svg = document.getElementById("paintSvg");

        // 📌 해상도별 viewBox 자동 설정
        (function setViewBoxByDevice() {
            const w = window.innerWidth;
            const h = window.innerHeight;

            // 삼성
            if (w === 1180 && h === 648) {
                svg.setAttribute("viewBox", "15 219 590 327");
            }
            // 큐브
            else {
                svg.setAttribute("viewBox", "34 225 566 397");
            }
        })();

        let clipRef = document.getElementById("clipRef1");
        let drawingGroup = document.getElementById("drawingGroup1"); // 초기 그리기 그룹은 첫 번째 영역
        let fillArea = document.getElementById("fillArea1");
        let drawing = false;
        let currentPath = null;
        let callFlutter = false;

        // 확대/축소 변수
        let scale = 1;
        let lastDistance = 0;
        let currentX = 0, currentY = 0; // 드래그 위치
        let isDragging = false;

        // 영역 클릭 시 해당 영역으로 전환
        function onclickPath(id) {
            fillArea = document.getElementById(`fillArea${id}`);

            if (!fillArea) return;

            drawingGroup = document.getElementById(`drawingGroup${id}`);
        }

        // SVG 좌표 변환 함수
        function getSVGCoords(event) {
            const point = svg.createSVGPoint();
            let x, y;

            if (event.touches) {
                x = event.touches[0].clientX;
                y = event.touches[0].clientY;
            } else {
                x = event.clientX;
                y = event.clientY;
            }

            point.x = x;
            point.y = y;
            return point.matrixTransform(svg.getScreenCTM().inverse());
        }

        // 경로 내부 점인지 확인하는 함수
        function isInsidePath(x, y) {
            const point = svg.createSVGPoint();
            point.x = x;
            point.y = y;
            return fillArea.isPointInFill(point);
        }

        // 그리기 시작 함수
        function startDrawing(e) {
            e.preventDefault();
            const { x, y } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            drawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            currentPath.setAttribute("stroke", "blue");
            currentPath.setAttribute("stroke-width", "5");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("points", `${x},${y}`);
            drawingGroup.appendChild(currentPath);

            resetDrawTimer();
        }

        // 그리기 이동 함수
        function moveDrawing(e) {
            if (!drawing) return;
            e.preventDefault();

            const { x, y } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            let points = currentPath.getAttribute("points");
            points += ` ${x},${y}`;
            currentPath.setAttribute("points", points);
        }

        // 그리기 종료 함수
        function stopDrawing() {
            drawing = false;
        }

        // Flutter 호출 함수
        function resetDrawTimer() {
            if (!callFlutter) {
                console.log(callFlutter);
                callFlutter = true;
                window.drawCanvas.postMessage(JSON.stringify({ data: 'draw' }));
            }
        }

        // 줌 처리 함수
        function handleZoom(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                let distance = Math.sqrt(dx * dx + dy * dy);

                if (lastDistance !== 0) {
                    let delta = distance - lastDistance;
                    scale += delta * 0.005; // 줌 속도
                    scale = Math.max(1.0, Math.min(2.5, scale)); // 줌 한계
                    svg.setAttribute("style", `transform: scale(${scale})`);
                }

                lastDistance = distance;
                e.preventDefault();
            }
        }

        // 첫 번째 터치 시 초기화
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                lastDistance = Math.sqrt(dx * dx + dy * dy);
            }
        }

        // 터치 끝날 때
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                lastDistance = 0;
            }
        }

        // 드래그 이동 함수
        function handleMouseDown(e) {
            isDragging = true;
            currentX = e.clientX;
            currentY = e.clientY;
            svg.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging) return;

            const dx = e.clientX - currentX;
            const dy = e.clientY - currentY;
            currentX = e.clientX;
            currentY = e.clientY;

            const transform = svg.getAttribute('transform') || 'translate(0, 0)';
            const regex = /translate\((-?\d+), (-?\d+)\)/;
            const match = transform.match(regex);

            const newX = (match ? parseInt(match[1]) : 0) + dx;
            const newY = (match ? parseInt(match[2]) : 0) + dy;
            svg.setAttribute('transform', `translate(${newX}, ${newY})`);
        }

        function handleMouseUp() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        function handleMouseLeave() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        // 마우스 이벤트 리스너
        svg.addEventListener("mousedown", startDrawing);
        svg.addEventListener("mousemove", moveDrawing);
        svg.addEventListener("mouseup", stopDrawing);
        svg.addEventListener("mouseleave", stopDrawing);

        // 터치 이벤트 리스너
        svg.addEventListener("touchstart", function (e) {
            if (e.touches.length === 1) {
                startDrawing(e);
            } else if (e.touches.length === 2) {
                handleTouchStart(e);
            }
        });

        svg.addEventListener("touchmove", function (e) {
            if (e.touches.length === 1) {
                moveDrawing(e);
            } else if (e.touches.length === 2) {
                handleZoom(e);
            }
        });

        svg.addEventListener("touchend", function (e) {
            stopDrawing();
            handleTouchEnd(e);
        });

    </script>
</body>

</html>