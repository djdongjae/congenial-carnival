<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=no">
    <title>몬테소리 콘텐츠</title>
    <style>
        svg {
            /*border: 1px solid #000;*/
            display: block;
            margin: 5px auto;
            cursor: crosshair;
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <svg id="paintSvg" data-name="paintSvg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="120 186 437 408">
        <!-- Generator: Adobe Illustrator 29.3.0, SVG Export Plug-In . SVG Version: 2.1.0 Build 146)  -->
        <defs>
            <style>
                .st0 {
                    fill: #ea5234;
                }

                .st1 {
                    fill: #62268a;
                }

                .st2 {
                    fill: #d1bf9c;
                }

                .st3 {
                    fill: #ef8567;
                }

                .st4 {
                    fill: #f3f3f3;
                    stroke: #d3d3d4;
                    stroke-width: .87px;
                }

                .st4,
                .st5,
                .st6 {
                    stroke-miterlimit: 10;
                }

                .st7 {
                    fill: #343535;
                }

                .st5 {
                    stroke: #d2d2d3;
                    stroke-width: 2px;
                }

                .st5,
                .st6 {
                    fill: white;
                }

                .st8 {
                    fill: #b9779a;
                }

                .st9 {
                    fill: #446b33;
                }

                .st10 {
                    fill: #231815;
                }

                .st11 {
                    fill: #f6c74e;
                }

                .st12 {
                    fill: #1a7fc1;
                }

                .st6 {
                    stroke: #231815;
                    stroke-width: .61px;
                }

                .st13 {
                    fill: #c1571e;
                }

                .st14 {
                    fill: #ed6d2a;
                }

                .st15 {
                    fill: #898989;
                }
            </style>
        </defs>
        <!-- 마스킹 그룹 -->
        <defs>
            <clipPath id="clipPath1">
                <use id="clipRef1" href="#fillArea1" />
            </clipPath>
            <clipPath id="clipPath2">
                <use id="clipRef2" href="#fillArea2" />
            </clipPath>
        </defs>
        <!-- <rect class="st6" x="47.58" y="92.95" width="503.96" height="503.96" />
        <g>
            <path class="st10" d="M79.55,165.75h-7.47v-1.64h9.64v1.24l-5.79,13.82h-2.2l5.84-13.42Z" />
            <path class="st10" d="M82.81,177.43h2.16v2.18h-2.16v-2.18Z" />
            <path class="st10"
                d="M92.95,179.13v-1.62h7.79v-4.58h-5.69v-9.28h13.46v1.62h-11.48v6.05h11.59v1.62h-5.9v4.58h7.87v1.62h-17.64Z" />
            <path class="st10"
                d="M111.79,166.76v-1.57h10.6v1.57h-10.6ZM117.27,174.03c-2.58,0-4.51-1.26-4.51-3.21s1.91-3.23,4.51-3.23,4.51,1.24,4.51,3.23-1.93,3.21-4.51,3.21ZM114.5,163.95v-1.6h5.67v1.6h-5.67ZM117.27,169.09c-1.36,0-2.56.67-2.56,1.72s1.2,1.7,2.56,1.7,2.56-.67,2.56-1.7-1.2-1.72-2.56-1.72ZM121.32,181.61c-4.22,0-6.51-1.26-6.51-3.4s2.29-3.42,6.51-3.42,6.55,1.3,6.55,3.42-2.33,3.4-6.55,3.4ZM116.85,178.21c0,1.15,1.64,1.87,4.47,1.87s4.51-.69,4.51-1.87-1.66-1.87-4.51-1.87-4.47.73-4.47,1.87ZM122.75,167.27h3.04v-5.19h1.97v12.53h-1.97v-2.16h-3.04v-1.55h3.04v-2.06h-3.04v-1.57Z" />
            <path class="st10"
                d="M130.54,172.01v-1.6h17.64v1.6h-17.64ZM132.56,181.46v-4.79h11.44v-1.39h-11.48v-1.62h13.46v4.49h-11.44v1.66h12.18v1.64h-14.15ZM139.38,169.24c-4.2,0-6.74-1.24-6.74-3.44s2.54-3.44,6.74-3.44,6.76,1.24,6.76,3.44-2.52,3.44-6.76,3.44ZM134.7,165.8c0,1.11,1.81,1.87,4.68,1.87s4.72-.76,4.72-1.87-1.83-1.87-4.72-1.87-4.68.76-4.68,1.87Z" />
            <path class="st10"
                d="M160.09,176.23v-3.46c-1.91.08-3.61.1-5.31.15l-.31-1.64c2.25,0,4.35-.02,6.49-.1,2.5-.13,4.43-.25,6.26-.46l.15,1.49c-1.3.19-3.34.36-5.29.46v3.57h-1.97ZM160.91,170.23c-2.98,0-5.19-1.36-5.19-3.61s2.2-3.63,5.19-3.63,5.19,1.43,5.19,3.65-2.16,3.59-5.19,3.59ZM157.07,181.1v-5.69h1.97v4.09h12.2v1.6h-14.17ZM160.91,164.58c-1.85,0-3.07.88-3.07,2.06s1.22,2.02,3.07,2.02,3.07-.86,3.07-2.02-1.2-2.06-3.07-2.06ZM168.91,177.09v-2.08h-3.84v-1.47h3.84v-11.46h1.95v15.01h-1.95Z" />
            <path class="st10"
                d="M173.38,168.32v-1.6h11.57v1.6h-11.57ZM179.26,177.62c-2.77,0-4.62-1.74-4.62-4.09s1.85-4.12,4.62-4.12,4.6,1.78,4.6,4.12-1.83,4.09-4.6,4.09ZM176.28,164.96v-1.62h5.84v1.62h-5.84ZM179.26,171.05c-1.51,0-2.65,1.03-2.65,2.48s1.11,2.46,2.65,2.46,2.65-1.01,2.65-2.46-1.13-2.48-2.65-2.48ZM188.56,171.86v9.74h-1.97v-19.53h1.97v8.13h3.11v1.66h-3.11Z" />
            <path class="st10"
                d="M192.28,173.63v-1.62h17.64v1.62h-17.64ZM194.63,181.17v-5.77h1.97v4.16h11.44v1.62h-13.42ZM194.7,169.72v-6.84h1.97v5.23h11.3v1.62h-13.27Z" />
            <path class="st10"
                d="M225.21,172.66c-1.34-.67-3.23-2.5-3.8-3.88-.48,1.57-2.18,3.57-3.91,4.54l-1.18-1.43c2.14-1.18,4.09-3.57,4.09-6.42v-2.27h1.91v2.23c0,2.9,2.23,4.96,3.93,5.75l-1.05,1.49ZM230.98,181.63v-5.23h-11.27v-1.6h13.23v6.82h-1.95ZM231.03,173.86v-5.25h-2.2v5h-1.89v-11.17h1.89v4.56h2.2v-4.91h1.91v11.78h-1.91Z" />
            <path class="st10"
                d="M235.23,178.96v-1.62h17.64v1.62h-17.64ZM244.05,173.86c-4.24,0-7.03-2.04-7.03-5.06s2.79-5.06,7.03-5.06,7.05,2.06,7.05,5.06-2.81,5.06-7.05,5.06ZM244.05,165.46c-3.02,0-5.02,1.36-5.02,3.34s1.99,3.34,5.02,3.34,5.04-1.34,5.04-3.34-1.99-3.34-5.04-3.34Z" />
            <path class="st10"
                d="M254.02,179.13v-1.62h7.79v-3.09h-5.67v-6.28h11.36v-2.86h-11.4v-1.62h13.37v6.09h-11.36v3.04h11.88v1.62h-6.21v3.09h7.87v1.62h-17.64Z" />
            <path class="st10"
                d="M286.95,172.66c-1.34-.67-3.23-2.5-3.8-3.88-.48,1.57-2.18,3.57-3.91,4.54l-1.18-1.43c2.14-1.18,4.09-3.57,4.09-6.42v-2.27h1.91v2.23c0,2.9,2.23,4.96,3.93,5.75l-1.05,1.49ZM292.72,181.63v-5.23h-11.27v-1.6h13.23v6.82h-1.95ZM292.77,173.86v-5.25h-2.2v5h-1.89v-11.17h1.89v4.56h2.2v-4.91h1.91v11.78h-1.91Z" />
            <path class="st10"
                d="M307.99,172.45c-1.7-.5-4.01-1.93-4.87-3.59-.61,1.68-2.65,3.36-4.83,4.12l-1.09-1.51c2.37-.67,4.54-2.46,4.85-4.64h-4.09v-1.6h10.56v1.6h-4.37c.36,2.1,2.79,3.61,4.83,4.07l-.99,1.55ZM300.26,181.46v-4.83h10.75v-1.55h-10.79v-1.62h12.77v4.66h-10.75v1.72h11.42v1.62h-13.4ZM300.5,163.8v-1.57h5.31v1.57h-5.31ZM311.01,172.43v-10.35h1.97v10.35h-1.97Z" />
            <path class="st10"
                d="M315.83,168.51v-1.62h9.66v1.62h-9.66ZM320.8,177.07c-2.54,0-4.33-1.62-4.33-3.84,0-2.35,1.79-3.82,4.33-3.82s4.28,1.49,4.28,3.82-1.74,3.84-4.28,3.84ZM317.99,165.17v-1.62h5.25v1.62h-5.25ZM320.8,171c-1.43,0-2.41.97-2.41,2.23s.99,2.25,2.41,2.25,2.39-.99,2.39-2.25-1.01-2.23-2.39-2.23ZM330.36,181.61v-9.85h-2.02v8.88h-1.89v-18.14h1.89v7.64h2.02v-8.06h1.91v19.53h-1.91Z" />
            <path class="st10"
                d="M344.32,173.75v3.84h7.87v1.62h-17.64v-1.62h7.79v-3.84h-5.65v-10.31h1.97v3.55h9.41v-3.55h1.97v10.31h-5.73ZM348.08,168.59h-9.41v3.55h9.41v-3.55Z" />
            <path class="st10"
                d="M361.88,176.74c-1.45-.99-3.17-3.17-3.76-5.29-.46,2.16-2.1,4.47-4.01,5.79l-1.24-1.39c2.31-1.47,4.28-4.66,4.28-8.59v-3.34h1.91v3.32c0,3.76,1.81,6.72,4.01,8.1l-1.2,1.39ZM364.1,180.64v-10.02h-3.09v-1.62h3.09v-6.49h1.89v18.12h-1.89ZM367.95,181.61v-19.53h1.91v19.53h-1.91Z" />
            <path class="st10"
                d="M372.15,179.13v-1.62h4.24v-3.46l1.97-.06v3.53h5.17v-3.53l1.97.06v3.46h4.28v1.62h-17.64ZM380.97,173.48c-4.37,0-7.26-1.99-7.26-5.04s2.9-5.06,7.26-5.06,7.26,2.02,7.26,5.06-2.9,5.04-7.26,5.04ZM380.97,165c-3.15,0-5.23,1.39-5.23,3.44s2.08,3.42,5.23,3.42,5.25-1.39,5.25-3.42-2.08-3.44-5.25-3.44Z" />
            <path class="st10" d="M391.09,177.43h2.16v2.18h-2.16v-2.18Z" />
        </g> -->
        <g>
            <path class="st5" onmousedown="onclickPath(1)" ontouchstart="onclickPath(1)" id="fillArea1"
                pointer-events="visiblePainted"
                d="M178.57,415.49s-6.86-103.18,71.52-162.36c20.14-15.21,43.16-19.73,67-1.23,23.84,18.5,60.83,59.19,71.93,140.99l-11.92-14.39-27.54,39.05-27.95-39.87-27.95,40.28-28.77-39.87-26.31,39.05-29.6-38.64-26.31,39.05-4.11-2.06Z" />
            <path class="st5" onmousedown="onclickPath(2)" ontouchstart="onclickPath(2)" id="fillArea2"
                pointer-events="visiblePainted"
                d="M179.4,427.41l2.47,1.64,27.13-39.87,29.18,39.87,26.31-39.05,29.6,39.46,27.13-40.69,28.77,41.1,27.13-40.69,12.33,16.85s10.69,87.14-69.88,128.66c-80.56,41.52-143.04-61.25-140.17-107.28Z" />
        </g>
        <g>
            <rect class="st2" x="419.28" y="486.17" width="78.87" height="48.79" rx="6.9" ry="6.9" />
            <g>
                <path class="st10"
                    d="M439.97,504.09c-.04,5.75-2.37,9.97-6.96,13.01l-1.46-1.54c3.8-2.27,5.99-5.81,6.23-9.67h-5.1v-1.8h7.28ZM442.29,520.05v-6.6h-2.63v-1.74h2.63v-3.08h-2.17v-1.72h2.17v-4.75h2.08v17.89h-2.08ZM446,520.96v-19.18h2.1v19.18h-2.1Z" />
                <path class="st10"
                    d="M461.62,512.62c-1.88.41-5.12.65-7.93.67h-2.43v-6.13h6.25v-2.37h-6.33v-1.78h8.54v5.85h-6.25v2.67c2.33,0,5.97-.16,7.87-.61l.28,1.7ZM453.18,520.5v-5.48h2.21v3.7h10.64v1.78h-12.85ZM465.44,509.23v6.54h-2.23v-13.98h2.23v5.6h2.81v1.84h-2.81Z" />
                <path class="st10"
                    d="M469.21,506.56v-1.74h10.34v1.74h-10.34ZM474.61,513.56c-2.57,0-4.51-1.27-4.51-3.16s1.92-3.16,4.51-3.16,4.47,1.27,4.47,3.18-1.92,3.14-4.47,3.14ZM471.84,503.72v-1.76h5.6v1.76h-5.6ZM478.6,521.02c-4.13,0-6.45-1.34-6.45-3.42s2.33-3.4,6.45-3.4,6.47,1.36,6.47,3.4-2.35,3.42-6.47,3.42ZM474.61,508.88c-1.27,0-2.37.57-2.37,1.52s1.11,1.54,2.37,1.54,2.33-.59,2.33-1.54-1.09-1.52-2.33-1.52ZM474.41,517.62c0,1.03,1.54,1.72,4.19,1.72s4.19-.69,4.19-1.72-1.5-1.72-4.19-1.72-4.19.71-4.19,1.72ZM479.97,506.27h2.77v-4.49h2.23v12.22h-2.23v-2.33h-2.77v-1.78h2.77v-1.82h-2.77v-1.8Z" />
            </g>
        </g>
        <g id="colorPalette">
            <rect class="st9" x="414.94" y="236.18" width="40" height="40" rx="7" ry="7" />
            <rect class="st1" x="459.48" y="236.18" width="40" height="40" rx="7" ry="7" />
            <rect class="st8" x="504.02" y="236.18" width="40" height="40" rx="7" ry="7" />
            <rect class="st14" x="414.94" y="286.72" width="40" height="40" rx="7" ry="7" />
            <rect class="st13" x="459.48" y="286.72" width="40" height="40" rx="7" ry="7" />
            <rect class="st3" x="504.02" y="286.72" width="40" height="40" rx="7" ry="7" />
            <rect class="st0" x="414.94" y="337.26" width="40" height="40" rx="7" ry="7" />
            <rect class="st12" x="459.48" y="337.26" width="40" height="40" rx="7" ry="7" />
            <rect class="st11" x="504.02" y="337.26" width="40" height="40" rx="7" ry="7" />
            <rect class="st4" x="414.94" y="387.8" width="40" height="40" rx="7" ry="7" />
            <rect class="st15" x="459.48" y="387.8" width="40" height="40" rx="7" ry="7" />
            <rect class="st7" x="504.02" y="387.8" width="40" height="40" rx="7" ry="7" />
        </g>
        <!-- 사용자가 그리는 영역 (마스킹 적용) -->
        <g id="drawingGroup1" clip-path="url(#clipPath1)"></g>
        <g id="drawingGroup2" clip-path="url(#clipPath2)"></g>
    </svg>

    <script>
        const svg = document.getElementById("paintSvg");

        // 📌 해상도별 viewBox 자동 설정
        (function setViewBoxByDevice() {
            const w = window.innerWidth;
            const h = window.innerHeight;

            // 삼성
            if (w === 1180 && h === 648) {
                svg.setAttribute("viewBox", "30 219 670 327");
            }
            // 큐브
            else {
                svg.setAttribute("viewBox", "34 225 626 397");
            }
        })();

        let clipRef = document.getElementById("clipRef1");
        let drawingGroup = document.getElementById("drawingGroup1"); // 초기 그리기 그룹은 첫 번째 영역
        let fillArea = document.getElementById("fillArea1");
        let drawing = false;
        let currentPath = null;
        let callFlutter = false;
        let currentColor = "white"; // 현재 그리기 색상

        // 확대/축소 변수
        let scale = 1;
        let lastDistance = 0;
        let currentX = 0, currentY = 0; // 드래그 위치
        let isDragging = false;

        const colorMap = {
            // row 1
            "414.94-236.18": "#446b33", // st9
            "459.48-236.18": "#62268a", // st1
            "504.02-236.18": "#b9779a", // st8
            // row 2
            "414.94-286.72": "#ed6d2a", // st14
            "459.48-286.72": "#c1571e", // st13
            "504.02-286.72": "#ef8567", // st3
            // row 3
            "414.94-337.26": "#ea5234", // st0
            "459.48-337.26": "#1a7fc1", // st12
            "504.02-337.26": "#f6c74e", // st11
            // row 4
            "414.94-387.8": "#f3f3f3",  // st4
            "459.48-387.8": "#898989", // st15
            "504.02-387.8": "#343535", // st7
        };

        document.querySelectorAll("#colorPalette rect").forEach((rect) => {
            function setColor() {
                const key = `${rect.getAttribute("x")}-${rect.getAttribute("y")}`;
                const fill = colorMap[key];
                if (fill) {
                    currentColor = fill;
                    console.log(`Color selected: ${currentColor}`);
                }
            }

            rect.addEventListener("click", (e) => {
                e.stopPropagation();
                setColor();
            });

            rect.addEventListener("touchstart", (e) => {
                e.stopPropagation();
                setColor();
            });
        });

        // 영역 클릭 시 해당 영역으로 전환
        function onclickPath(id) {
            fillArea = document.getElementById(`fillArea${id}`);

            if (!fillArea) return;

            drawingGroup = document.getElementById(`drawingGroup${id}`);

            console.log(`Switched to fillArea${id}`);
        }

        // SVG 좌표 변환 함수
        function getSVGCoords(event) {
            const point = svg.createSVGPoint();
            let x, y;

            if (event.touches) {
                x = event.touches[0].clientX;
                y = event.touches[0].clientY;
            } else {
                x = event.clientX;
                y = event.clientY;
            }

            point.x = x;
            point.y = y;
            return point.matrixTransform(svg.getScreenCTM().inverse());
        }

        // 경로 내부 점인지 확인하는 함수
        function isInsidePath(x, y) {
            const point = svg.createSVGPoint();
            point.x = x;
            point.y = y;
            return fillArea.isPointInFill(point);
        }

        // 그리기 시작 함수
        function startDrawing(e) {
            e.preventDefault();
            const {
                x,
                y
            } = getSVGCoords(e);
            // if (!isInsidePath(x, y)) return;

            drawing = true;
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            currentPath.setAttribute("stroke", currentColor);
            currentPath.setAttribute("stroke-width", "40");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("points", `${x},${y}`);
            currentPath.setAttribute("pointer-events", "none");
            drawingGroup.appendChild(currentPath);

            resetDrawTimer();
        }

        // 그리기 이동 함수
        function moveDrawing(e) {
            if (!drawing) return;
            e.preventDefault();

            const {
                x,
                y
            } = getSVGCoords(e);
            if (!isInsidePath(x, y)) return;

            let points = currentPath.getAttribute("points");
            points += ` ${x},${y}`;
            currentPath.setAttribute("points", points);
        }

        // 그리기 종료 함수
        function stopDrawing() {
            drawing = false;
        }

        // Flutter 호출 함수
        function resetDrawTimer() {
            if (!callFlutter) {
                console.log(callFlutter);
                callFlutter = true;
                window.drawCanvas.postMessage(JSON.stringify({
                    data: 'draw'
                }));
            }
        }

        // 줌 처리 함수
        function handleZoom(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                let distance = Math.sqrt(dx * dx + dy * dy);

                if (lastDistance !== 0) {
                    let delta = distance - lastDistance;
                    scale += delta * 0.005; // 줌 속도
                    scale = Math.max(1.0, Math.min(2.5, scale)); // 줌 한계 (0.5배 ~ 3배)
                    svg.setAttribute("style", `transform: scale(${scale})`);
                }

                lastDistance = distance; // 마지막 거리 업데이트
                e.preventDefault(); // 기본 동작(스크롤 등)을 막음
            }
        }

        // 첫 번째 터치 시 초기화
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                lastDistance = Math.sqrt(dx * dx + dy * dy); // 초기 거리 계산
            }
        }

        // 터치 끝날 때
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                lastDistance = 0; // 두 손가락이 하나로 떨어지면 초기화
            }
        }

        // 드래그 이동 함수
        function handleMouseDown(e) {
            isDragging = true;
            currentX = e.clientX;
            currentY = e.clientY;
            svg.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging) return;

            const dx = e.clientX - currentX;
            const dy = e.clientY - currentY;
            currentX = e.clientX;
            currentY = e.clientY;

            const transform = svg.getAttribute('transform') || 'translate(0, 0)';
            const regex = /translate\((-?\d+), (-?\d+)\)/;
            const match = transform.match(regex);

            const newX = (match ? parseInt(match[1]) : 0) + dx;
            const newY = (match ? parseInt(match[2]) : 0) + dy;
            svg.setAttribute('transform', `translate(${newX}, ${newY})`);
        }

        function handleMouseUp() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        function handleMouseLeave() {
            isDragging = false;
            svg.style.cursor = 'grab';
        }

        // 마우스 이벤트 리스너
        svg.addEventListener("mousedown", startDrawing);
        svg.addEventListener("mousemove", moveDrawing);
        svg.addEventListener("mouseup", stopDrawing);
        svg.addEventListener("mouseleave", stopDrawing);

        // 터치 이벤트 리스너
        svg.addEventListener("touchstart", function (e) {
            if (e.touches.length === 1) {
                startDrawing(e); // 한 손가락으로 그리기 시작
            } else if (e.touches.length === 2) {
                handleTouchStart(e); // 두 손가락 줌 시작
            }
        });

        svg.addEventListener("touchmove", function (e) {
            if (e.touches.length === 1) {
                moveDrawing(e); // 한 손가락으로 그리기 이동
            } else if (e.touches.length === 2) {
                handleZoom(e); // 두 손가락 줌 처리
            }
        });

        svg.addEventListener("touchend", function (e) {
            stopDrawing(); // 그리기 종료
            handleTouchEnd(e); // 두 손가락 처리 종료
        });
    </script>
</body>

</html>